import React, { useState, useEffect } from 'react';
import { Calendar, Activity, Moon, Droplets, AlertCircle, TrendingUp, Heart, Wind, Thermometer, Clock, Plus, ChevronRight, Zap, Sun } from 'lucide-react';

const LipoReliefApp = () => {
  const [activeTab, setActiveTab] = useState('dashboard');
  const [entries, setEntries] = useState([]);
  const [showQuickLog, setShowQuickLog] = useState(false);

  // Lade gespeicherte Daten beim Start
  useEffect(() => {
    const loadData = async () => {
      try {
        const result = await window.storage.get('lipedema-entries');
        if (result) {
          setEntries(JSON.parse(result.value));
        }
      } catch (error) {
        console.log('Keine vorherigen Daten gefunden');
      }
    };
    loadData();
  }, []);

  // Speichere Daten bei √Ñnderungen
  const saveEntries = async (newEntries) => {
    setEntries(newEntries);
    try {
      await window.storage.set('lipedema-entries', JSON.stringify(newEntries));
    } catch (error) {
      console.error('Speichern fehlgeschlagen:', error);
    }
  };

  // Quick Log Funktion
  const addQuickEntry = (painLevel, rlsLevel) => {
    const newEntry = {
      id: Date.now(),
      date: new Date().toISOString(),
      painLevel,
      rlsLevel,
      type: 'quick'
    };
    saveEntries([newEntry, ...entries]);
    setShowQuickLog(false);
  };

  // KI-Analyse f√ºr Muster
  const analyzePatterns = () => {
    if (entries.length < 3) return null;
    
    const recentEntries = entries.slice(0, 7);
    const avgPain = recentEntries.reduce((sum, e) => sum + (e.painLevel || 0), 0) / recentEntries.length;
    const avgRls = recentEntries.reduce((sum, e) => sum + (e.rlsLevel || 0), 0) / recentEntries.length;
    
    return { avgPain: avgPain.toFixed(1), avgRls: avgRls.toFixed(1) };
  };

  const patterns = analyzePatterns();

  // Intelligente Vorschl√§ge basierend auf aktuellen Werten
  const getSmartSuggestions = () => {
    const latestEntry = entries[0];
    if (!latestEntry) return [];

    const suggestions = [];
    
    if (latestEntry.painLevel >= 7) {
      suggestions.push({
        icon: <Thermometer className="w-5 h-5 text-blue-400" />,
        title: 'Akute Schmerzlinderung',
        action: 'K√ºhle Kompression f√ºr 15 Min. + Beine hochlegen',
        priority: 'high'
      });
    }

    if (latestEntry.rlsLevel >= 6) {
      suggestions.push({
        icon: <Moon className="w-5 h-5 text-purple-400" />,
        title: 'Restless Legs Protokoll',
        action: 'Magnesium + Wadendehnung + Fu√ümassage',
        priority: 'high'
      });
    }

    if (patterns && patterns.avgPain > 6) {
      suggestions.push({
        icon: <Activity className="w-5 h-5 text-green-400" />,
        title: 'Entz√ºndung reduzieren',
        action: 'Entz√ºndungshemmende Ern√§hrung verst√§rken',
        priority: 'medium'
      });
    }

    suggestions.push({
      icon: <Droplets className="w-5 h-5 text-cyan-400" />,
      title: 'Hydration Check',
      action: '2L Wasser heute erreicht?',
      priority: 'medium'
    });

    return suggestions;
  };

  const suggestions = getSmartSuggestions();

  // Dashboard View
  const DashboardView = () => (
    <div className="space-y-4 pb-20">
      {/* Quick Status Card */}
      <div className="bg-gradient-to-br from-purple-500 to-pink-500 rounded-2xl p-6 text-white shadow-lg">
        <h2 className="text-xl font-bold mb-2">Wie geht es dir?</h2>
        <p className="text-purple-100 mb-4">Schneller Check-in</p>
        <button 
          onClick={() => setShowQuickLog(true)}
          className="bg-white text-purple-600 px-6 py-3 rounded-xl font-semibold hover:bg-purple-50 transition w-full flex items-center justify-center gap-2"
        >
          <Plus className="w-5 h-5" />
          Aktuellen Zustand erfassen
        </button>
      </div>

      {/* AI Insights */}
      {patterns && (
        <div className="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl p-6 border border-blue-100">
          <div className="flex items-center gap-2 mb-4">
            <TrendingUp className="w-5 h-5 text-blue-600" />
            <h3 className="font-bold text-gray-800">7-Tage Analyse</h3>
          </div>
          <div className="grid grid-cols-2 gap-4">
            <div>
              <p className="text-sm text-gray-600 mb-1">√ò Schmerz</p>
              <p className="text-3xl font-bold text-blue-600">{patterns.avgPain}/10</p>
            </div>
            <div>
              <p className="text-sm text-gray-600 mb-1">√ò Restless Legs</p>
              <p className="text-3xl font-bold text-purple-600">{patterns.avgRls}/10</p>
            </div>
          </div>
        </div>
      )}

      {/* Smart Suggestions */}
      <div>
        <h3 className="font-bold text-gray-800 mb-3 flex items-center gap-2">
          <Zap className="w-5 h-5 text-yellow-500" />
          Personalisierte Empfehlungen
        </h3>
        <div className="space-y-2">
          {suggestions.map((suggestion, idx) => (
            <div 
              key={idx}
              className={`p-4 rounded-xl border-2 ${
                suggestion.priority === 'high' 
                  ? 'bg-red-50 border-red-200' 
                  : 'bg-white border-gray-200'
              }`}
            >
              <div className="flex items-start gap-3">
                {suggestion.icon}
                <div className="flex-1">
                  <h4 className="font-semibold text-gray-800 mb-1">{suggestion.title}</h4>
                  <p className="text-sm text-gray-600">{suggestion.action}</p>
                </div>
                <ChevronRight className="w-5 h-5 text-gray-400" />
              </div>
            </div>
          ))}
        </div>
      </div>

      {/* Notfall Toolbox */}
      <div className="bg-gradient-to-br from-red-50 to-orange-50 rounded-2xl p-6 border border-red-200">
        <h3 className="font-bold text-red-800 mb-3 flex items-center gap-2">
          <AlertCircle className="w-5 h-5" />
          Notfall-Toolbox
        </h3>
        <div className="grid grid-cols-2 gap-2">
          <button className="bg-white p-3 rounded-lg text-sm font-medium text-gray-700 hover:bg-red-100 transition">
            üßä K√ºhlprotokoll
          </button>
          <button className="bg-white p-3 rounded-lg text-sm font-medium text-gray-700 hover:bg-red-100 transition">
            ü¶µ RLS Akuthilfe
          </button>
          <button className="bg-white p-3 rounded-lg text-sm font-medium text-gray-700 hover:bg-red-100 transition">
            üíä Medikations-Log
          </button>
          <button className="bg-white p-3 rounded-lg text-sm font-medium text-gray-700 hover:bg-red-100 transition">
            üßò‚Äç‚ôÄÔ∏è Atem√ºbung
          </button>
        </div>
      </div>
    </div>
  );

  // Tracking View
  const TrackingView = () => (
    <div className="space-y-4 pb-20">
      <h2 className="text-2xl font-bold text-gray-800">Verlauf</h2>
      {entries.length === 0 ? (
        <div className="text-center py-12">
          <Calendar className="w-16 h-16 text-gray-300 mx-auto mb-4" />
          <p className="text-gray-500">Noch keine Eintr√§ge vorhanden</p>
          <button 
            onClick={() => setShowQuickLog(true)}
            className="mt-4 bg-purple-500 text-white px-6 py-2 rounded-lg"
          >
            Ersten Eintrag erstellen
          </button>
        </div>
      ) : (
        <div className="space-y-3">
          {entries.map(entry => (
            <div key={entry.id} className="bg-white p-4 rounded-xl border border-gray-200">
              <div className="flex justify-between items-start mb-3">
                <span className="text-sm text-gray-500">
                  {new Date(entry.date).toLocaleDateString('de-DE', { 
                    weekday: 'short', 
                    day: '2-digit', 
                    month: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                  })}
                </span>
              </div>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <p className="text-xs text-gray-500 mb-1">Schmerz</p>
                  <div className="flex items-center gap-2">
                    <div className="flex-1 bg-gray-200 rounded-full h-2">
                      <div 
                        className="bg-red-500 h-2 rounded-full transition-all"
                        style={{ width: `${(entry.painLevel / 10) * 100}%` }}
                      />
                    </div>
                    <span className="text-sm font-bold">{entry.painLevel}/10</span>
                  </div>
                </div>
                <div>
                  <p className="text-xs text-gray-500 mb-1">RLS</p>
                  <div className="flex items-center gap-2">
                    <div className="flex-1 bg-gray-200 rounded-full h-2">
                      <div 
                        className="bg-purple-500 h-2 rounded-full transition-all"
                        style={{ width: `${(entry.rlsLevel / 10) * 100}%` }}
                      />
                    </div>
                    <span className="text-sm font-bold">{entry.rlsLevel}/10</span>
                  </div>
                </div>
              </div>
            </div>
          ))}
        </div>
      )}
    </div>
  );

  // Quick Log Modal
  const QuickLogModal = () => {
    const [pain, setPain] = useState(5);
    const [rls, setRls] = useState(5);

    return (
      <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div className="bg-white rounded-2xl p-6 max-w-md w-full">
          <h3 className="text-xl font-bold mb-6">Aktueller Zustand</h3>
          
          <div className="space-y-6">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Schmerz-Level: {pain}/10
              </label>
              <input 
                type="range" 
                min="0" 
                max="10" 
                value={pain}
                onChange={(e) => setPain(parseInt(e.target.value))}
                className="w-full h-3 bg-gray-200 rounded-lg appearance-none cursor-pointer"
              />
              <div className="flex justify-between text-xs text-gray-500 mt-1">
                <span>Kein Schmerz</span>
                <span>Maximal</span>
              </div>
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Restless Legs: {rls}/10
              </label>
              <input 
                type="range" 
                min="0" 
                max="10" 
                value={rls}
                onChange={(e) => setRls(parseInt(e.target.value))}
                className="w-full h-3 bg-gray-200 rounded-lg appearance-none cursor-pointer"
              />
              <div className="flex justify-between text-xs text-gray-500 mt-1">
                <span>Keine Symptome</span>
                <span>Sehr stark</span>
              </div>
            </div>
          </div>

          <div className="flex gap-3 mt-8">
            <button 
              onClick={() => setShowQuickLog(false)}
              className="flex-1 px-4 py-3 border-2 border-gray-300 rounded-xl font-semibold text-gray-700 hover:bg-gray-50"
            >
              Abbrechen
            </button>
            <button 
              onClick={() => addQuickEntry(pain, rls)}
              className="flex-1 px-4 py-3 bg-purple-500 text-white rounded-xl font-semibold hover:bg-purple-600"
            >
              Speichern
            </button>
          </div>
        </div>
      </div>
    );
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-purple-50 via-pink-50 to-blue-50">
      {/* Header */}
      <div className="bg-gradient-to-r from-purple-600 to-pink-500 text-white p-6 shadow-lg">
        <div className="flex items-center gap-3 mb-2">
          <Heart className="w-8 h-8" />
          <h1 className="text-2xl font-bold">LipoRelief</h1>
        </div>
        <p className="text-purple-100 text-sm">Deine intelligente Begleiterin</p>
      </div>

      {/* Main Content */}
      <div className="p-4">
        {activeTab === 'dashboard' && <DashboardView />}
        {activeTab === 'tracking' && <TrackingView />}
      </div>

      {/* Bottom Navigation */}
      <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg">
        <div className="flex justify-around p-4">
          <button
            onClick={() => setActiveTab('dashboard')}
            className={`flex flex-col items-center gap-1 ${
              activeTab === 'dashboard' ? 'text-purple-600' : 'text-gray-400'
            }`}
          >
            <Activity className="w-6 h-6" />
            <span className="text-xs font-medium">Dashboard</span>
          </button>
          <button
            onClick={() => setActiveTab('tracking')}
            className={`flex flex-col items-center gap-1 ${
              activeTab === 'tracking' ? 'text-purple-600' : 'text-gray-400'
            }`}
          >
            <Calendar className="w-6 h-6" />
            <span className="text-xs font-medium">Verlauf</span>
          </button>
        </div>
      </div>

      {/* Quick Log Modal */}
      {showQuickLog && <QuickLogModal />}
    </div>
  );
};

export default LipoReliefApp;
